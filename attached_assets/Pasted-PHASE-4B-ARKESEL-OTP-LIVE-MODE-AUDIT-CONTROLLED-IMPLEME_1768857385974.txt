PHASE 4B ‚Äî ARKESEL OTP (LIVE MODE)

AUDIT ‚Üí CONTROLLED IMPLEMENTATION MASTER PROMPT (VERY STRICT)

ROLE: Senior Backend Engineer
MODE: Audit First ‚Üí Minimal Live Integration
RISK LEVEL: HIGH (Auth System)
ABSOLUTE RULE: OTP must be globally disable-able from Admin without redeploy.

‚∏ª

1Ô∏è‚É£ MANDATORY AUDIT (DO NOT WRITE CODE YET)

Before changing anything, produce an explicit audit report covering:

A. Current Auth & OTP State
	‚Ä¢	Is OTP currently:
	‚Ä¢	Required for registration?
	‚Ä¢	Required for login?
	‚Ä¢	Required for password reset?
	‚Ä¢	Disabled / stubbed?
	‚Ä¢	List every route referencing OTP (file + line).
	‚Ä¢	Confirm whether login/registration currently works without OTP.

B. Arkesel Integration Status

Verify:
	‚Ä¢	API key present in DB or env
	‚Ä¢	Sender ID present
	‚Ä¢	Endpoint currently used (SMS vs OTP)
	‚Ä¢	No sandbox support exists (confirm)

C. Failure Risk Mapping

Explicitly answer:
	‚Ä¢	What happens if Arkesel is down?
	‚Ä¢	What happens if OTP delivery fails?
	‚Ä¢	Can users be permanently locked out?

üö´ DO NOT IMPLEMENT ANYTHING UNTIL AUDIT IS COMPLETE AND REPORTED

‚∏ª

2Ô∏è‚É£ LIVE OTP IMPLEMENTATION (CONTROLLED)

Proceed only after audit approval.

üîê Core Rules
	‚Ä¢	OTP is LIVE
	‚Ä¢	OTP can be globally disabled via Admin ‚Üí Integrations
	‚Ä¢	OTP must fail open when disabled (auth continues)

‚∏ª

3Ô∏è‚É£ ADMIN KILL-SWITCH (MANDATORY)

Add / verify a single authoritative flag:

integrations.id = 'arkesel'
otp_enabled = true | false

Enforcement Rules
	‚Ä¢	If otp_enabled === false:
	‚Ä¢	OTP is NOT sent
	‚Ä¢	OTP verification is skipped
	‚Ä¢	Auth proceeds normally
	‚Ä¢	No redeploy required
	‚Ä¢	No env flag duplication

üö´ No per-user overrides
üö´ No frontend trust
üö´ Server-enforced only

‚∏ª

4Ô∏è‚É£ OTP FLOW (MINIMAL & SAFE)

OTP Generation
	‚Ä¢	Server-side only
	‚Ä¢	6 digits
	‚Ä¢	Expiry: 5 minutes
	‚Ä¢	Stored with:
	‚Ä¢	phone
	‚Ä¢	purpose (register / login / reset)
	‚Ä¢	expires_at
	‚Ä¢	attempts
	‚Ä¢	verified_at (nullable)

OTP Rules
	‚Ä¢	Single-use
	‚Ä¢	Max 3 attempts
	‚Ä¢	Expired OTP rejected
	‚Ä¢	New OTP invalidates old ones

SMS Delivery
	‚Ä¢	Use Arkesel LIVE endpoint
	‚Ä¢	Sender ID must be configurable
	‚Ä¢	Errors must be logged but must not crash auth

‚∏ª

5Ô∏è‚É£ STRICT NON-REGRESSION GUARANTEES

You MUST NOT:
	‚Ä¢	Break login without OTP when disabled
	‚Ä¢	Change existing auth routes signatures
	‚Ä¢	Change session handling
	‚Ä¢	Introduce new UI
	‚Ä¢	Add email fallback
	‚Ä¢	Add new providers
	‚Ä¢	Modify unrelated validation

OTP must be additive, not invasive.

‚∏ª

6Ô∏è‚É£ FAILURE HANDLING (REQUIRED)

If OTP send fails:
	‚Ä¢	User receives a clear error
	‚Ä¢	OTP attempt is not consumed
	‚Ä¢	No partial account state created
	‚Ä¢	Admin logs record failure reason

If verification fails:
	‚Ä¢	Attempts increment
	‚Ä¢	Lock after max attempts
	‚Ä¢	No account creation/login

‚∏ª

7Ô∏è‚É£ LOGGING & AUDITABILITY

Required logs:

[ARKESEL_OTP_SEND]
[ARKESEL_OTP_VERIFY]
[ARKESEL_OTP_DISABLED]
[ARKESEL_OTP_FAILURE]

üö´ Never log OTP codes in production logs

‚∏ª

8Ô∏è‚É£ VERIFICATION (MANDATORY)

Provide manual test results:
	‚Ä¢	OTP enabled ‚Üí register ‚Üí success
	‚Ä¢	OTP enabled ‚Üí wrong code ‚Üí blocked
	‚Ä¢	OTP enabled ‚Üí expired ‚Üí blocked
	‚Ä¢	OTP disabled ‚Üí register/login works
	‚Ä¢	Arkesel failure ‚Üí graceful error
	‚Ä¢	Admin toggles OTP without redeploy

‚∏ª

9Ô∏è‚É£ DELIVERABLE FORMAT (STRICT)

Your response MUST include:
	1.	Audit report
	2.	Implementation summary
	3.	Exact files changed (path + reason)
	4.	Manual test results
	5.	Explicit confirmation:

‚ÄúOTP is LIVE, admin-controlled, fail-safe, and introduces no regressions.‚Äù

‚∏ª

üö® AUTO-FAIL CONDITIONS

Task is FAILED if you:
	‚Ä¢	Skip audit
	‚Ä¢	Hard-require OTP without kill-switch
	‚Ä¢	Lock users out on Arkesel failure
	‚Ä¢	Add features beyond OTP
	‚Ä¢	Touch unrelated auth logic

‚∏ª
