â¸»

ğŸ”’ STEP 1 â€” EMAIL ABSTRACTION MASTER PROMPT

(Audit-first Â· Strict Â· Replit-proof Â· Zero feature creep)

ğŸ¯ OBJECTIVE

Create a provider-agnostic email abstraction layer for Kiosk only if it does not already exist.

This step is FOUNDATION ONLY.
No auth changes. No password reset yet. No real emails.

â¸»

ğŸš¨ ABSOLUTE RULES
	â€¢	âŒ Do NOT write code until audit is complete and reported
	â€¢	âŒ Do NOT modify registration, login, OTP, or verification flows
	â€¢	âŒ Do NOT send real emails
	â€¢	âŒ Do NOT add UI, templates, retries, or queues
	â€¢	âŒ Do NOT tightly couple to Resend
	â€¢	âŒ Do NOT add database tables
	â€¢	âŒ Do NOT refactor unrelated code

Any violation = FAIL

â¸»

1ï¸âƒ£ REQUIRED â€” AUDIT FIRST (MANDATORY)

Before writing any code, perform a read-only audit and report findings.

Audit Checklist (Report Each Item)

Search the codebase for:
	â€¢	Existing email services or utilities
	â€¢	Any sendEmail, email.ts, mailer, nodemailer, or provider SDK usage
	â€¢	Any abstraction or partial abstraction already present
	â€¢	Admin integrations related to email
	â€¢	Any environment variables related to email providers
	â€¢	Any unused or half-implemented email logic

Audit Output (Required)

You must report:
	â€¢	âœ… Files already related to email (if any)
	â€¢	âœ… What they currently do
	â€¢	âœ… Whether an abstraction already exists
	â€¢	âœ… Whether it is safe to extend or must be replaced
	â€¢	âœ… Confirmation that no auth or password reset currently depends on email

âš ï¸ If an abstraction already exists, you must:
	â€¢	Reuse it
	â€¢	OR explicitly justify why it must be replaced

No assumptions allowed.

â¸»

2ï¸âƒ£ IMPLEMENTATION (ONLY AFTER AUDIT APPROVAL)

Proceed only if audit confirms abstraction is missing or incomplete.

A. Canonical Email Contract

Create (or extend):

src/lib/email/email-provider.ts

export type EmailType =
  | 'password_reset'
  | 'account_verification'
  | 'system_notification';

export interface SendEmailParams {
  to: string;
  subject: string;
  type: EmailType;
  html: string;
  text?: string;
  metadata?: {
    userId?: string;
    tokenId?: string;
    orderId?: string;
  };
}

export interface EmailProvider {
  send(params: SendEmailParams): Promise<{
    success: boolean;
    providerMessageId?: string;
    error?: string;
  }>;
}


â¸»

B. Single Email Service Entry Point

src/lib/email/email-service.ts

Rules:
	â€¢	This must be the ONLY place that sends email
	â€¢	Must respect admin kill-switch (integrations)
	â€¢	Must never throw

â¸»

C. Mock Provider ONLY (No Real Sending)

src/lib/email/providers/mock.provider.ts

Behavior:
	â€¢	Log payload to console
	â€¢	Always return { success: true }
	â€¢	Used by default

âš ï¸ Resend must NOT be installed yet

â¸»

D. Provider Selector

src/lib/email/index.ts

Environment-based selection, mock by default.

â¸»

3ï¸âƒ£ STRICT EXIT REPORT (MANDATORY)

You must explicitly confirm:
	â€¢	âœ… Audit completed before coding
	â€¢	âœ… Files added or reused
	â€¢	âœ… No auth flows modified
	â€¢	âœ… No real emails sent
	â€¢	âœ… Mock provider is default
	â€¢	âœ… Abstraction is provider-agnostic
	â€¢	âœ… No regressions observed

â¸»

ğŸš« OUT OF SCOPE â€” DO NOT TOUCH
	â€¢	Password reset
	â€¢	Email verification
	â€¢	OTP
	â€¢	Resend SDK
	â€¢	Templates
	â€¢	Admin UI
	â€¢	Messaging
	â€¢	Notifications

â¸»

ğŸŸ¢ SUCCESS DEFINITION

Kiosk now has a clean, audited, future-proof email backbone
with zero behavioral change to the app.

â¸»