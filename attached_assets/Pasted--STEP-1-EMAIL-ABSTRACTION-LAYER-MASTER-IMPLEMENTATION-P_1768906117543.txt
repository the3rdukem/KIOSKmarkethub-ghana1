
ğŸ”’ STEP 1 â€” EMAIL ABSTRACTION LAYER

MASTER IMPLEMENTATION PROMPT (STRICT)

âš ï¸ READ CAREFULLY â€” NON-NEGOTIABLE RULES

You are implementing ONLY the missing email abstraction layer.

âŒ Do NOT:
	â€¢	Modify any existing DAL files
	â€¢	Touch authentication, registration, or login
	â€¢	Add password reset
	â€¢	Add OTP
	â€¢	Add UI
	â€¢	Send real emails
	â€¢	Add Resend / SendGrid / SES SDKs
	â€¢	Add environment variables
	â€¢	Change database schema

âœ… You MUST:
	â€¢	Reuse existing email config & templates DAL
	â€¢	Add a provider-agnostic abstraction
	â€¢	Default to mock / dry-run behavior
	â€¢	Respect admin kill-switch (is_enabled, dryRun)
	â€¢	Ensure zero regressions

â¸»

ğŸ§¾ AUDIT CONTEXT (CONFIRMED)

Already exists (DO NOT MODIFY):
	â€¢	src/lib/db/dal/email.ts (config + templates only)
	â€¢	Admin API for email config & templates
	â€¢	email_templates table
	â€¢	Provider type enum (sendgrid | resend | ses | none)

Confirmed missing (YOUR TASK):
	â€¢	âŒ No sendEmail() function
	â€¢	âŒ No provider interface
	â€¢	âŒ No provider selector
	â€¢	âŒ No mock provider
	â€¢	âŒ No email runtime layer

â¸»

ğŸ¯ OBJECTIVE

Create a provider-agnostic email runtime layer that:
	â€¢	Exposes one entry point: sendEmail()
	â€¢	Uses mock provider only for now
	â€¢	Respects admin kill-switch + dry-run mode
	â€¢	Logs email intent safely (no secrets)
	â€¢	Can be extended later to Resend without refactor

â¸»

ğŸ—‚ï¸ REQUIRED FILES (CREATE ONLY THESE)

src/lib/email/
â”œâ”€â”€ email-provider.ts
â”œâ”€â”€ email-service.ts
â”œâ”€â”€ providers/
â”‚   â””â”€â”€ mock.provider.ts
â””â”€â”€ index.ts

âŒ Do not create any other files
âŒ Do not modify existing files

â¸»

ğŸ“ IMPLEMENTATION DETAILS (STRICT)

1ï¸âƒ£ email-provider.ts

Define a provider contract only:
	â€¢	SendEmailParams type:
	â€¢	to: string
	â€¢	subject: string
	â€¢	html?: string
	â€¢	text?: string
	â€¢	templateId?: string
	â€¢	templateData?: Record<string, any>
	â€¢	EmailProvider interface:
	â€¢	send(params: SendEmailParams): Promise<{ success: boolean; messageId?: string }>;

No logic. No imports from DAL.

â¸»

2ï¸âƒ£ providers/mock.provider.ts

Implement a mock email provider:
	â€¢	Logs:
	â€¢	recipient
	â€¢	subject
	â€¢	templateId (if provided)
	â€¢	Never sends email
	â€¢	Always returns { success: true, messageId: 'mock' }
	â€¢	No secrets in logs
	â€¢	No side effects

â¸»

3ï¸âƒ£ index.ts

Provider selector:
	â€¢	Import getEmailProviderConfig() from DAL
	â€¢	If:
	â€¢	provider = 'none'
	â€¢	OR is_enabled === false
	â€¢	OR dryRun === true
â†’ return mock provider

âš ï¸ Even if provider is resend | sendgrid | ses, STILL return mock provider
(No real provider logic yet.)

â¸»

4ï¸âƒ£ email-service.ts

This is the ONLY public entry point.

Implement:

sendEmail(params: SendEmailParams): Promise<{ success: boolean }>

Rules:
	â€¢	Fetch provider config via DAL
	â€¢	If disabled â†’ log + return { success: true }
	â€¢	Call provider .send()
	â€¢	Catch errors â†’ log safely â†’ return { success: false }
	â€¢	NEVER throw
	â€¢	NEVER block application flows

â¸»

ğŸ§ª VERIFICATION REQUIREMENTS (MANDATORY)

After implementation, confirm:
	â€¢	App builds without errors
	â€¢	No auth flow changes
	â€¢	No email is sent
	â€¢	Console logs show mock email intent
	â€¢	Admin email config still works
	â€¢	No new env vars added
	â€¢	No schema changes
	â€¢	No tests broken

â¸»

ğŸš« OUT OF SCOPE (DO NOT TOUCH)
	â€¢	Password reset
	â€¢	Email verification
	â€¢	OTP
	â€¢	Resend SDK
	â€¢	Admin email sending UI
	â€¢	Rate limiting
	â€¢	Retry queues
	â€¢	Background jobs

â¸»

âœ… SUCCESS CRITERIA

This step is complete ONLY IF:
	â€¢	sendEmail() exists and is callable
	â€¢	Kill-switch respected
	â€¢	Dry-run respected
	â€¢	Provider-agnostic architecture in place
	â€¢	Zero regressions verified

â¸»

ğŸ›‘ STOP AFTER THIS STEP

Do NOT proceed to password reset or Resend integration until explicitly instructed.