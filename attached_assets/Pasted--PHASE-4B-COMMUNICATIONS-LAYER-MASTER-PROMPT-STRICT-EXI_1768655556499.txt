
üîí PHASE 4B ‚Äî COMMUNICATIONS LAYER MASTER PROMPT

(STRICT ‚Ä¢ EXIT-ORIENTED ‚Ä¢ ZERO FEATURE CREEP)

ABSOLUTE RULES (NON-NEGOTIABLE)
	1.	DO NOT touch Phases 1‚Äì4A code unless a direct dependency is broken.
	2.	DO NOT re-implement checkout, orders, payments, reviews, or auth.
	3.	DO NOT add real-time features (no sockets, no push, no typing indicators).
	4.	DO NOT add marketing, campaigns, or bulk email features.
	5.	DO NOT modify database schemas unless explicitly required below.
	6.	DO NOT claim success until ALL exit checks pass.
	7.	VERIFY what already exists first.
If a feature is already implemented, document and skip it.

Failure to follow any rule = FAILED PHASE.

‚∏ª

PHASE 4B SCOPE (LOCKED)

Phase 4B consists of EXACTLY THREE SYSTEMS:

1Ô∏è‚É£ In-App Notifications
2Ô∏è‚É£ Messaging / Conversations
3Ô∏è‚É£ Email Infrastructure (FOUNDATION ONLY)

Nothing else.

‚∏ª

1Ô∏è‚É£ IN-APP NOTIFICATIONS (SYSTEM EVENTS)

PURPOSE

Surface important platform events inside the app UI.

REQUIRED EVENTS
	‚Ä¢	Order created
	‚Ä¢	Order paid
	‚Ä¢	Order cancelled
	‚Ä¢	Vendor fulfilled order
	‚Ä¢	Vendor replied to review
	‚Ä¢	Admin moderation action (review hidden / restored)

REQUIREMENTS
	‚Ä¢	Database-backed notifications table
	‚Ä¢	Fields:
	‚Ä¢	id
	‚Ä¢	user_id
	‚Ä¢	role (buyer/vendor/admin)
	‚Ä¢	type
	‚Ä¢	payload (JSON)
	‚Ä¢	is_read
	‚Ä¢	created_at
	‚Ä¢	Bell icon UI with unread badge
	‚Ä¢	Mark-as-read logic
	‚Ä¢	Notifications are append-only (no edits, no deletes)

FORBIDDEN

‚ùå Push notifications
‚ùå Email notifications here
‚ùå Real-time sockets

‚∏ª

2Ô∏è‚É£ MESSAGING / CONVERSATIONS (BUSINESS-SCOPED)

PURPOSE

Structured communication tied to orders and reviews.

INCLUDED THREAD TYPES
	‚Ä¢	Buyer ‚Üî Vendor (Order-scoped)
	‚Ä¢	Buyer ‚Üî Vendor (Review replies after 24h lock)
	‚Ä¢	System messages (order status changes)

MESSAGE RULES
	‚Ä¢	Text only
	‚Ä¢	Max length enforced
	‚Ä¢	Messages stored in DB
	‚Ä¢	Read receipts optional (boolean)

PERMISSIONS
	‚Ä¢	Buyer:
	‚Ä¢	Can message vendor on own order
	‚Ä¢	Can reply to review thread after 24h
	‚Ä¢	Vendor:
	‚Ä¢	Can message buyer only on paid orders
	‚Ä¢	One reply per review
	‚Ä¢	Admin:
	‚Ä¢	Read-only access for dispute resolution

FORBIDDEN

‚ùå Attachments
‚ùå Emojis / reactions
‚ùå Live chat
‚ùå Editing or deleting messages

‚∏ª

3Ô∏è‚É£ EMAIL INFRASTRUCTURE (FOUNDATION ONLY)

PURPOSE

Prepare platform for transactional emails later.

REQUIRED
	‚Ä¢	Admin API configuration for email provider:
	‚Ä¢	SendGrid OR Resend OR SES
	‚Ä¢	Secure key storage
	‚Ä¢	Provider status health check
	‚Ä¢	Email template registry (DB or filesystem)
	‚Ä¢	Dry-run mode (no emails sent by default)

EXPLICITLY EXCLUDED

‚ùå Marketing emails
‚ùå Newsletters
‚ùå Email preferences UI
‚ùå Campaign scheduling

‚∏ª

VERIFICATION FIRST (MANDATORY)

Before writing ANY code:
	1.	Audit existing notification logic
	2.	Audit any existing message tables
	3.	Audit email provider config
	4.	Report:
	‚Ä¢	What exists
	‚Ä¢	What partially exists
	‚Ä¢	What is missing

ONLY implement missing items.

‚∏ª

EXIT AUDIT REQUIREMENTS (MUST PASS)

Notifications
	‚Ä¢	Notifications persist across sessions
	‚Ä¢	Unread badge accurate
	‚Ä¢	No duplicate notifications
	‚Ä¢	Correct role scoping

Messaging
	‚Ä¢	Messages tied to order/review IDs
	‚Ä¢	Unauthorized access blocked
	‚Ä¢	Vendor cannot message unpaid buyers
	‚Ä¢	No orphaned threads

Email Infrastructure
	‚Ä¢	Provider configurable via Admin
	‚Ä¢	Keys never exposed client-side
	‚Ä¢	Templates load without errors
	‚Ä¢	No emails sent automatically

‚∏ª

SUCCESS CRITERIA

You may report ‚ÄúPhase 4B Complete‚Äù ONLY if:
	‚Ä¢	No Phase 1‚Äì4A regressions
	‚Ä¢	No console errors
	‚Ä¢	No schema drift
	‚Ä¢	All exit checks pass
	‚Ä¢	No out-of-scope features added

‚∏ª

FINAL WARNING

If you:
	‚Ä¢	Add real-time features
	‚Ä¢	Touch payments logic
	‚Ä¢	Add marketing tools
	‚Ä¢	Skip verification
	‚Ä¢	Or claim completion without proof

THE PHASE IS CONSIDERED FAILED.

‚∏ª

üéØ DELIVERABLE

A stable communications layer that:
	‚Ä¢	Feels professional
	‚Ä¢	Is audit-safe
	‚Ä¢	Enables Phase 5 polish
	‚Ä¢	Does NOT introduce tech debt

‚∏ª
