STEP 2 ‚Äî PASSWORD RESET FLOW (EMAIL-BASED)

MASTER PROMPT (STRICT ¬∑ AUDIT-FIRST ¬∑ NO FEATURE CREEP)

ROLE

You are acting as a senior backend engineer working on a production-bound marketplace platform.
Your task is to implement a secure password reset flow using the existing email abstraction, with zero regressions.

‚∏ª

üö® HARD RULES (NON-NEGOTIABLE)
	1.	AUDIT FIRST ‚Äî NO CODING UNTIL AUDIT IS COMPLETE
	2.	DO NOT modify existing auth flows unless explicitly required
	3.	DO NOT integrate any real email provider yet
	4.	DO NOT introduce OTP
	5.	DO NOT add UI pages or frontend flows
	6.	DO NOT add unrelated features
	7.	DO NOT break login or registration
	8.	DO NOT bypass the email kill-switch
	9.	DO NOT reuse session tokens for password reset
	10.	ALL changes must be server-side only

Any violation = FAILURE.

‚∏ª

üß™ PHASE A ‚Äî MANDATORY AUDIT (REPORT ONLY)

Before writing code, produce an audit report answering all of the following:

1Ô∏è‚É£ Existing Auth Capabilities
	‚Ä¢	Confirm whether any password reset routes already exist
(/api/auth/password-reset, /forgot-password, etc.)
	‚Ä¢	Confirm how passwords are currently hashed and verified
	‚Ä¢	Confirm how user lookup by email is handled

2Ô∏è‚É£ Existing Email Infrastructure
	‚Ä¢	Confirm that sendEmail() exists and is callable
	‚Ä¢	Confirm that email templates exist but sending is mocked
	‚Ä¢	Confirm kill-switch behavior (is_enabled, dryRun)

3Ô∏è‚É£ Database State
	‚Ä¢	Confirm whether any reset-token table already exists
	‚Ä¢	Confirm whether users table has reset-related fields
	‚Ä¢	Confirm token expiration utilities (if any)

‚ö†Ô∏è Do not proceed until audit is reported and approved implicitly by completeness.

‚∏ª

üß© PHASE B ‚Äî IMPLEMENTATION (AFTER AUDIT)

B1Ô∏è‚É£ Database (Minimal & Isolated)

Create a new table only if none exists:

password_reset_tokens
	‚Ä¢	id
	‚Ä¢	user_id (FK ‚Üí users.id)
	‚Ä¢	token_hash (NOT plaintext)
	‚Ä¢	expires_at (UTC)
	‚Ä¢	used_at (nullable)
	‚Ä¢	created_at

Rules:
	‚Ä¢	One active token per user
	‚Ä¢	Tokens expire after 15‚Äì30 minutes
	‚Ä¢	Tokens are single-use

‚∏ª

B2Ô∏è‚É£ API Routes (SERVER ONLY)

1Ô∏è‚É£ Request Reset
POST /api/auth/password-reset/request

Input:
	‚Ä¢	email

Behavior:
	‚Ä¢	Always return 200 OK (prevent email enumeration)
	‚Ä¢	If user exists:
	‚Ä¢	Generate secure random token
	‚Ä¢	Hash token before storing
	‚Ä¢	Store expiration
	‚Ä¢	Call sendEmail() with mock provider
	‚Ä¢	If user does NOT exist:
	‚Ä¢	Do nothing silently

üö´ Do NOT reveal whether the email exists.

‚∏ª

2Ô∏è‚É£ Confirm Reset
POST /api/auth/password-reset/confirm

Input:
	‚Ä¢	token
	‚Ä¢	newPassword

Behavior:
	‚Ä¢	Validate token hash
	‚Ä¢	Check expiration
	‚Ä¢	Check unused
	‚Ä¢	Enforce password rules (existing policy)
	‚Ä¢	Update user password
	‚Ä¢	Invalidate token (set used_at)
	‚Ä¢	Return success

Failures must be:
	‚Ä¢	Explicit
	‚Ä¢	Non-leaky
	‚Ä¢	Non-verbose

‚∏ª

B3Ô∏è‚É£ Security Requirements (MANDATORY)
	‚Ä¢	Tokens must NEVER be stored in plaintext
	‚Ä¢	Tokens must NEVER be reusable
	‚Ä¢	Tokens must NEVER extend expiration
	‚Ä¢	Password reset must NOT log user in
	‚Ä¢	No session creation during reset
	‚Ä¢	All logic server-side only

‚∏ª

‚úâÔ∏è PHASE C ‚Äî EMAIL USAGE (MOCK ONLY)
	‚Ä¢	Use existing sendEmail() abstraction
	‚Ä¢	Use a password_reset template key
	‚Ä¢	Payload includes:
	‚Ä¢	reset link (token)
	‚Ä¢	expiration time
	‚Ä¢	Respect:
	‚Ä¢	is_enabled
	‚Ä¢	dryRun
	‚Ä¢	No real email sending

‚∏ª

üß™ PHASE D ‚Äî VERIFICATION CHECKLIST (MUST PASS ALL)

You must report explicitly on:
	‚Ä¢	Password reset request works with valid email
	‚Ä¢	Password reset request works with invalid email (no leak)
	‚Ä¢	Token expires correctly
	‚Ä¢	Token cannot be reused
	‚Ä¢	Login works after reset
	‚Ä¢	Login fails with old password
	‚Ä¢	Login works with new password
	‚Ä¢	Kill-switch disables email sending cleanly
	‚Ä¢	No regressions in:
	‚Ä¢	Login
	‚Ä¢	Registration
	‚Ä¢	Vendor flows
	‚Ä¢	Admin flows

‚∏ª

üßæ FINAL OUTPUT REQUIRED

Your final response MUST include:
	1.	‚úÖ Audit Report
	2.	‚úÖ Implementation Summary
	3.	‚úÖ Security Checklist
	4.	‚úÖ Explicit confirmation of NO regressions
	5.	‚ùå No future suggestions
	6.	‚ùå No optional enhancements

‚∏ª

SUCCESS CRITERIA

This step is considered complete only if:
	‚Ä¢	Password reset works end-to-end (API-level)
	‚Ä¢	Email abstraction is exercised safely
	‚Ä¢	No real emails sent
	‚Ä¢	No UI added
	‚Ä¢	No unrelated code touched

‚∏ª

FINAL NOTE

This is a foundational security feature.
Treat it as production-critical, not experimental.

Proceed carefully.

‚∏ª