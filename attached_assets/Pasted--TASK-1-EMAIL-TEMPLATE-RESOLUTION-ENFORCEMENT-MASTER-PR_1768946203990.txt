
üîí TASK 1 ‚Äî EMAIL TEMPLATE RESOLUTION & ENFORCEMENT

MASTER PROMPT (Audit-First, No Regression, Copy-Paste Ready)

Context

The platform already has:
	‚Ä¢	Email provider abstraction
	‚Ä¢	Resend provider wired
	‚Ä¢	Email templates stored in DB
	‚Ä¢	sendEmail() entry point

However:
	‚Ä¢	Templates are currently ignored
	‚Ä¢	Variable mismatches can fail silently
	‚Ä¢	Emails are not guaranteed to render correctly

This task is to finish email templates as a real, enforceable system.

This task must NOT introduce new features.

‚∏ª

STEP 0 ‚Äî MANDATORY AUDIT (DO NOT SKIP)

Before writing or changing any code:
	1.	List all existing email templates in the database:
	‚Ä¢	id
	‚Ä¢	name
	‚Ä¢	subject
	‚Ä¢	body_html / body_text
	‚Ä¢	expected variables (explicitly inferred)
	2.	List all current sendEmail() call sites, including:
	‚Ä¢	Password reset
	‚Ä¢	Any auth/system notifications
	‚Ä¢	Any order/messaging usage (even if disabled)
	3.	Identify:
	‚Ä¢	Which calls pass templateId
	‚Ä¢	Which calls pass raw html/text
	‚Ä¢	Any mismatches between template variables and payload data

‚û°Ô∏è Report audit findings first. Do NOT code until audit is complete.

‚∏ª

STEP 1 ‚Äî TEMPLATE RESOLUTION (CORE REQUIREMENT)

Implement template support inside the email service layer.

Rules:
	‚Ä¢	If templateId is provided:
	‚Ä¢	Load template from DB
	‚Ä¢	Compile subject + body using provided templateData
	‚Ä¢	If template is missing:
	‚Ä¢	Hard fail with a logged error
	‚Ä¢	If required variables are missing:
	‚Ä¢	Hard fail (no silent fallback)
	‚Ä¢	If extra variables are provided:
	‚Ä¢	Allowed, but ignored

‚úÖ Templates MUST work with Resend
‚ùå Do NOT add new template features
‚ùå Do NOT modify template schema

‚∏ª

STEP 2 ‚Äî VARIABLE ENFORCEMENT (NO SILENT FAILURES)

Add strict validation:
	‚Ä¢	Detect missing variables before send
	‚Ä¢	Log:
	‚Ä¢	templateId
	‚Ä¢	missing keys
	‚Ä¢	email recipient
	‚Ä¢	Return { success: false } explicitly

‚ö†Ô∏è Silent success is forbidden.

‚∏ª

STEP 3 ‚Äî PROVIDER BEHAVIOR (NO CHANGE IN SCOPE)

Rules:
	‚Ä¢	Resend provider must:
	‚Ä¢	Receive final resolved subject + html/text
	‚Ä¢	NOT know about templates
	‚Ä¢	Mock provider must:
	‚Ä¢	Log resolved output (not raw template)

‚ùå Do NOT add retry logic
‚ùå Do NOT add queues
‚ùå Do NOT add email previews

‚∏ª

STEP 4 ‚Äî REGRESSION SAFETY

You MUST confirm:
	‚Ä¢	No changes to:
	‚Ä¢	Auth flows
	‚Ä¢	Password reset logic
	‚Ä¢	Admin email config
	‚Ä¢	Database schema
	‚Ä¢	Dry-run mode still works
	‚Ä¢	Kill-switch still works
	‚Ä¢	Existing calls without templates still work

‚∏ª

STEP 5 ‚Äî EXIT REPORT (REQUIRED)

Return a concise report with:
	‚Ä¢	Audit summary (templates + call sites)
	‚Ä¢	What changed (files + purpose)
	‚Ä¢	Example of:
	‚Ä¢	Successful template send
	‚Ä¢	Failed send due to missing variable
	‚Ä¢	Explicit statement:
‚ÄúEmail templates are now first-class and enforced.‚Äù

‚∏ª

ABSOLUTE RULES
	‚Ä¢	‚ùå No new features
	‚Ä¢	‚ùå No UI changes
	‚Ä¢	‚ùå No naming refactors (MarketHub ‚Üí KIOSK is Phase 5)
	‚Ä¢	‚ùå No OTP, no auth expansion
	‚Ä¢	‚ùå No Phase 2‚Äì5 work

‚∏ª

STOP CONDITION

After Task 1:
	‚Ä¢	Templates MUST render correctly
	‚Ä¢	Failures MUST be visible
	‚Ä¢	Email must be functionally usable

‚û°Ô∏è Only after this passes audit may we proceed to Task 2 (Password Reset UI).

‚∏ª