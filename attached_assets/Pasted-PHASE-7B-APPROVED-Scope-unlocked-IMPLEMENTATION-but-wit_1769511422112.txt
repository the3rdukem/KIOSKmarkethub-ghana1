PHASE 7B APPROVED

Scope unlocked: IMPLEMENTATION ‚Äî but with discipline

Phase 7B is NOT courier integration yet.
It is the structural refactor that makes delivery possible without breaking trust, payments, or history.

‚∏ª

üõ†Ô∏è PHASE 7B ‚Äî ORDER STATUS REFACTOR

STRICT IMPLEMENTATION MASTER PROMPT

ROLE

You are a Core Systems Engineer implementing an approved design.

You are NOT a product designer.

You are NOT allowed to invent new flows.

You must implement exactly what was approved in Phase 7A.

‚∏ª

üö® GLOBAL RULES (NON-NEGOTIABLE)
	1.	‚ùå NO new features beyond approved design
	2.	‚ùå NO UX redesigns beyond what is required to support status changes
	3.	‚ùå NO courier API integrations
	4.	‚ùå NO third-party SDKs
	5.	‚ùå NO infra migration
	6.	‚ùå NO silent breaking changes

If something is unclear:
	‚Ä¢	STOP
	‚Ä¢	REPORT
	‚Ä¢	ASK FOR CONFIRMATION

‚∏ª

üéØ PHASE 7B OBJECTIVE

Refactor the order lifecycle to support:
	‚Ä¢	Vendor-initiated delivery
	‚Ä¢	External courier workflows
	‚Ä¢	Buyer dispute windows
	‚Ä¢	Fraud-resistant completion

WITHOUT:
	‚Ä¢	Breaking existing orders
	‚Ä¢	Affecting Paystack logic
	‚Ä¢	Affecting payouts
	‚Ä¢	Affecting reviews
	‚Ä¢	Affecting analytics

‚∏ª

üì¶ IMPLEMENTATION SCOPE (IN ORDER)

1Ô∏è‚É£ DATABASE & ENUM REFACTOR

Implement the approved three-track model:

Payment Status (UNCHANGED)

pending ‚Üí paid | failed | refunded

Order Status (NEW ‚Äî REPLACES CURRENT)

created
confirmed
preparing
ready_for_pickup
out_for_delivery
delivered
completed   (system, after 48h)
delivery_failed
cancelled   (admin only)
disputed

Rules:
	‚Ä¢	Must be strictly forward-only, except:
	‚Ä¢	delivery_failed ‚Üí out_for_delivery
	‚Ä¢	delivered ‚Üí disputed
	‚Ä¢	completed is terminal
	‚Ä¢	cancelled is terminal

‚ö†Ô∏è Existing orders MUST be migrated safely:
	‚Ä¢	processing ‚Üí preparing
	‚Ä¢	shipped ‚Üí out_for_delivery
	‚Ä¢	fulfilled ‚Üí delivered

No data loss allowed.

‚∏ª

2Ô∏è‚É£ ORDER ITEM FULFILLMENT STATUS (PER VENDOR ITEM)

Implement per-item fulfillment:

pending
packed
handed_to_courier
delivered

Rules:
	‚Ä¢	Vendor can only update their own items
	‚Ä¢	Order status progression depends on all items
	‚Ä¢	Partial fulfillment supported (multi-vendor order)

‚∏ª

3Ô∏è‚É£ STATUS TRANSITION GUARDS (CRITICAL)

You MUST enforce:

Transition	Allowed By
created ‚Üí confirmed	System (Paystack webhook)
confirmed ‚Üí preparing	Vendor
preparing ‚Üí ready_for_pickup	Vendor
ready_for_pickup ‚Üí out_for_delivery	Vendor
out_for_delivery ‚Üí delivered	Vendor
delivered ‚Üí completed	System (48h, no dispute)
delivered ‚Üí disputed	Buyer
* ‚Üí cancelled	Admin only

Any invalid transition:
	‚Ä¢	Return 409 Conflict
	‚Ä¢	Log audit entry
	‚Ä¢	Do NOT silently fail

‚∏ª

4Ô∏è‚É£ DISPUTE WINDOW ENFORCEMENT

Implement:
	‚Ä¢	48-hour timer after delivered
	‚Ä¢	Buyer can open dispute within window
	‚Ä¢	Dispute locks:
	‚Ä¢	payout
	‚Ä¢	completion
	‚Ä¢	Admin resolves dispute ‚Üí moves to completed or refund flow

No dispute UI polish yet ‚Äî logic only.

‚∏ª

5Ô∏è‚É£ AUDIT TRAIL (MANDATORY)

Every status change must record:
	‚Ä¢	previous_status
	‚Ä¢	new_status
	‚Ä¢	actor (system/vendor/buyer/admin)
	‚Ä¢	timestamp
	‚Ä¢	order_id
	‚Ä¢	item_id (if applicable)

This is non-optional.

‚∏ª

6Ô∏è‚É£ BACKWARD COMPATIBILITY CHECK

Verify explicitly:
	‚Ä¢	Old orders still render correctly
	‚Ä¢	Old admin views still load
	‚Ä¢	Analytics queries don‚Äôt break
	‚Ä¢	Reviews still reference correct order state
	‚Ä¢	Refund logic untouched

‚∏ª

üß™ REQUIRED TESTS (NO SKIPPING)

You must manually verify:
	‚Ä¢	Multi-vendor order
	‚Ä¢	Vendor A marks ready, Vendor B delays
	‚Ä¢	Buyer disputes after delivery
	‚Ä¢	Buyer misses dispute window ‚Üí auto completion
	‚Ä¢	Admin cancellation
	‚Ä¢	Payment success ‚Üí confirmed mapping
	‚Ä¢	Existing orders migration integrity

‚∏ª

üìÑ REQUIRED OUTPUT FORMAT (STRICT)

You MUST output:

‚∏ª

üìã PHASE 7B ‚Äî IMPLEMENTATION REPORT

A. Schema Changes
B. Migration Strategy
C. Status Transition Rules
D. Dispute Logic
E. Audit Trail
F. Backward Compatibility
G. Risks Introduced

‚∏ª

üö® BLOCKERS (IF ANY)
* List only blockers
* If none: NONE

‚∏ª

‚úÖ PHASE 7B EXIT DECISION
* READY FOR PHASE 7C
* or BLOCKED ‚Äî FIX REQUIRED

‚∏ª

üõë STOP AFTER REPORT
