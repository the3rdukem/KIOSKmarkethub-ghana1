STEP 3 ‚Äî RESEND EMAIL PROVIDER INTEGRATION

MASTER PROMPT (AUDIT-FIRST ¬∑ STRICT ¬∑ ZERO REGRESSION)

You are implementing STEP 3 of the Email System: integrating Resend as the first real email provider.

‚ö†Ô∏è THIS IS NOT A GREENFIELD TASK.
A partial email foundation already exists.
You MUST audit before writing code.

‚∏ª

‚õî HARD RULES (READ CAREFULLY)
	1.	AUDIT FIRST. DO NOT CODE UNTIL AUDIT IS COMPLETE
	2.	DO NOT modify existing DAL or auth flows
	3.	DO NOT send real emails unless explicitly enabled
	4.	DO NOT break dryRun or kill-switch behavior
	5.	DO NOT introduce feature creep (no marketing emails, no bulk sends)
	6.	DO NOT add UI or frontend changes
	7.	NO REGRESSIONS ‚Äî if anything breaks, stop and report

‚∏ª

üéØ SCOPE (WHAT YOU ARE ALLOWED TO DO)

‚úÖ You MAY:
	‚Ä¢	Add a Resend provider implementation
	‚Ä¢	Wire Resend into the existing email abstraction
	‚Ä¢	Respect is_enabled and dryRun
	‚Ä¢	Send transactional emails only when enabled
	‚Ä¢	Add minimal config validation
	‚Ä¢	Log provider health clearly

‚ùå You MAY NOT:
	‚Ä¢	Modify auth flows
	‚Ä¢	Add new tables
	‚Ä¢	Add resend-specific logic outside the provider
	‚Ä¢	Change existing email DAL logic
	‚Ä¢	Send marketing emails
	‚Ä¢	Add templates beyond what already exists

‚∏ª

üß™ PHASE 1 ‚Äî AUDIT (MANDATORY)

Before writing any code, produce an Audit Report covering:

A. Existing Email Infrastructure

Confirm and document:
	‚Ä¢	Files under src/lib/email/
	‚Ä¢	How sendEmail() is currently invoked
	‚Ä¢	Where provider selection occurs
	‚Ä¢	How dryRun and is_enabled are enforced
	‚Ä¢	Whether any code already references Resend

B. Existing Email Usage

Identify:
	‚Ä¢	Which flows currently call sendEmail() (password reset, etc.)
	‚Ä¢	Whether any flows expect synchronous vs async behavior
	‚Ä¢	Whether failures are handled gracefully

C. Environment & Config

Check:
	‚Ä¢	Are Resend API keys present anywhere? (ENV, DB, admin UI)
	‚Ä¢	How provider credentials are stored in integrations
	‚Ä¢	Whether provider type resend already exists in enums/types

‚õî STOP AFTER AUDIT
‚õî DO NOT IMPLEMENT UNTIL AUDIT IS COMPLETE AND SHARED

‚∏ª

üõ†Ô∏è PHASE 2 ‚Äî IMPLEMENTATION (ONLY AFTER AUDIT)

Once audit confirms what is missing, implement:

1Ô∏è‚É£ Resend Provider (NEW FILE ONLY)

Create:

src/lib/email/providers/resend.provider.ts

Must:
	‚Ä¢	Implement the existing EmailProvider interface
	‚Ä¢	Use Resend‚Äôs official SDK
	‚Ä¢	Support:
	‚Ä¢	subject
	‚Ä¢	html body
	‚Ä¢	plain text fallback
	‚Ä¢	from address
	‚Ä¢	Handle errors gracefully (no throws that crash auth)

‚∏ª

2Ô∏è‚É£ Provider Registration (Minimal Change)

Update provider selector to:
	‚Ä¢	Return Resend provider ONLY when:
	‚Ä¢	provider === ‚Äòresend‚Äô
	‚Ä¢	is_enabled === true
	‚Ä¢	dryRun === false

Otherwise:
	‚Ä¢	Fall back to mock provider

‚∏ª

3Ô∏è‚É£ Safety & Guards (REQUIRED)

Ensure:
	‚Ä¢	If Resend API key is missing ‚Üí fail gracefully
	‚Ä¢	If Resend throws ‚Üí return { success: false }
	‚Ä¢	No email is sent when:
	‚Ä¢	dryRun === true
	‚Ä¢	is_enabled === false

‚∏ª

üß™ PHASE 3 ‚Äî VERIFICATION (MANDATORY)

Provide a Verification Checklist proving:
	‚Ä¢	Mock provider still works
	‚Ä¢	No real emails sent unless enabled
	‚Ä¢	Password reset still functions in dry-run
	‚Ä¢	Resend sends ONLY when explicitly enabled
	‚Ä¢	No console errors
	‚Ä¢	No auth regressions
	‚Ä¢	No schema changes
	‚Ä¢	No UI changes

‚∏ª

üìÑ FINAL DELIVERABLE

Your final response MUST include:
	1.	Audit Report
	2.	List of Files Created / Modified
	3.	Verification Checklist
	4.	Clear statement: ‚ÄúSAFE TO PROCEED‚Äù or ‚ÄúBLOCKED‚Äù

‚∏ª

üîö SUCCESS CRITERIA

This task is complete ONLY IF:
	‚Ä¢	Email abstraction remains provider-agnostic
	‚Ä¢	Resend can be swapped out later without refactor
	‚Ä¢	Password reset emails can be sent safely
	‚Ä¢	Admin kill-switch still works
	‚Ä¢	Dry-run mode still works
	‚Ä¢	No regressions introduced

‚∏ª

üîê REMINDER

Kiosk is a trust-based marketplace.
Email is critical infrastructure, not a feature.

Proceed carefully.